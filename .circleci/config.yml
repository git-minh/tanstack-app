version: 2.1

# Orbs for common functionality
orbs:
  node: circleci/node@5.1.0

# Reusable executors
executors:
  node-executor:
    docker:
      - image: cimg/node:20.19
    working_directory: ~/project
    resource_class: medium

# Reusable commands
commands:
  restore-pnpm-cache:
    description: "Restore pnpm store cache"
    steps:
      - restore_cache:
          name: Restore pnpm store cache
          keys:
            - pnpm-store-v1-{{ checksum "pnpm-lock.yaml" }}
            - pnpm-store-v1-

  save-pnpm-cache:
    description: "Save pnpm store cache"
    steps:
      - save_cache:
          name: Save pnpm store cache
          key: pnpm-store-v1-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - ~/.local/share/pnpm/store

  restore-node-modules-cache:
    description: "Restore node_modules cache"
    steps:
      - restore_cache:
          name: Restore node_modules cache
          keys:
            - node-modules-v1-{{ checksum "pnpm-lock.yaml" }}
            - node-modules-v1-

  save-node-modules-cache:
    description: "Save node_modules cache"
    steps:
      - save_cache:
          name: Save node_modules cache
          key: node-modules-v1-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - node_modules
            - apps/*/node_modules
            - packages/*/node_modules

  restore-turbo-cache:
    description: "Restore Turborepo cache"
    steps:
      - restore_cache:
          name: Restore Turborepo cache
          keys:
            - turbo-v1-{{ .Branch }}-{{ .Revision }}
            - turbo-v1-{{ .Branch }}-
            - turbo-v1-

  save-turbo-cache:
    description: "Save Turborepo cache"
    steps:
      - save_cache:
          name: Save Turborepo cache
          key: turbo-v1-{{ .Branch }}-{{ .Revision }}
          paths:
            - .turbo
            - apps/*/.turbo
            - packages/*/.turbo

# Jobs
jobs:
  install:
    executor: node-executor
    steps:
      - checkout

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate
            pnpm --version

      # Restore caches
      - restore-pnpm-cache
      - restore-node-modules-cache

      # Install dependencies
      - run:
          name: Install dependencies
          command: pnpm install --frozen-lockfile

      # Save caches
      - save-pnpm-cache
      - save-node-modules-cache

      # Persist workspace for subsequent jobs
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  validate:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate

      # Restore Turborepo cache
      - restore-turbo-cache

      # Run type checking
      - run:
          name: Type checking
          command: pnpm check-types

      # Save Turborepo cache
      - save-turbo-cache

  test:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate

      # Restore Turborepo cache
      - restore-turbo-cache

      # Run tests with coverage
      - run:
          name: Run tests
          command: pnpm test

      # Run coverage for both packages
      - run:
          name: Generate test coverage
          command: |
            cd apps/web && pnpm test:coverage || true
            cd ../../packages/backend && pnpm test:coverage || true

      # Save Turborepo cache
      - save-turbo-cache

      # Store test results (if generated)
      - store_test_results:
          path: apps/web/test-results

      # Store coverage reports as artifacts
      - store_artifacts:
          path: apps/web/coverage
          destination: web-coverage

      - store_artifacts:
          path: packages/backend/coverage
          destination: backend-coverage

  build:
    # Use medium+ for more memory (3GB instead of 2GB)
    docker:
      - image: cimg/node:20.19
    working_directory: ~/project
    resource_class: medium+
    steps:
      - attach_workspace:
          at: ~/project

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate

      # Restore Turborepo cache
      - restore-turbo-cache

      # Build all packages
      - run:
          name: Build all packages
          command: |
            export VITE_CONVEX_URL="${VITE_CONVEX_URL}"
            export VITE_CONVEX_SITE_URL="${VITE_CONVEX_SITE_URL}"
            export NODE_OPTIONS="--max-old-space-size=2560"
            pnpm build

      # Save Turborepo cache
      - save-turbo-cache

      # Persist build artifacts
      - persist_to_workspace:
          root: ~/project
          paths:
            - .

  deploy-backend:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate

      # Deploy to Convex
      - run:
          name: Deploy backend to Convex
          command: |
            cd packages/backend
            export CONVEX_DEPLOY_KEY="${CONVEX_DEPLOY_KEY}"
            npx convex deploy --yes

      # Store deployment info
      - store_artifacts:
          path: packages/backend/convex/_generated
          destination: convex-generated

  deploy-frontend:
    executor: node-executor
    steps:
      - attach_workspace:
          at: ~/project

      # Install pnpm
      - run:
          name: Install pnpm
          command: |
            sudo corepack enable
            corepack prepare pnpm@10.16.1 --activate

      # Deploy to Cloudflare Workers
      - run:
          name: Deploy frontend to Cloudflare
          command: |
            cd apps/web
            export CLOUDFLARE_API_TOKEN="${CLOUDFLARE_API_TOKEN}"
            export VITE_CONVEX_URL="${VITE_CONVEX_URL}"
            export VITE_CONVEX_SITE_URL="${VITE_CONVEX_SITE_URL}"
            npx wrangler deploy --var VITE_CONVEX_URL:"${VITE_CONVEX_URL}" --var VITE_CONVEX_SITE_URL:"${VITE_CONVEX_SITE_URL}"

      # Store deployment artifacts
      - store_artifacts:
          path: apps/web/.output
          destination: cloudflare-output

# Workflows
workflows:
  version: 2

  # Main CI/CD pipeline
  build-test-deploy:
    jobs:
      - install:
          filters:
            branches:
              only:
                - master

      - validate:
          requires:
            - install
          filters:
            branches:
              only:
                - master

      - test:
          requires:
            - install
          filters:
            branches:
              only:
                - master

      - build:
          requires:
            - validate
            - test
          filters:
            branches:
              only:
                - master

      - deploy-backend:
          requires:
            - build
          filters:
            branches:
              only:
                - master

      - deploy-frontend:
          requires:
            - deploy-backend
          filters:
            branches:
              only:
                - master
